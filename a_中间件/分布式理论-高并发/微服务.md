### 什么是微服务架构?
1.'单个'小型的但有业务功能的服务'，有业务处理和轻量通讯机制，可以部署在单个或多个服务器上。
   一种松耦合的、有一定的有界上下文的面向服务架构
   
### 优点
1. 聚焦一个指定的业务功能或业务需求
2. 能够被小团队单独开发
3. 松耦合的，是有功能意义的服务，无论是在开发阶段或部署阶段都是独立的
4. 能使用不同的语言开发, 允许你利用融合最新技术
5. 能够即时被要求扩展
6. 快速更新，因此系统会随着时间不断变化和演进。可替代性模块化设计。

### 缺点 
- 运维方面
   主要包括配置、部署、监控与告警和日志收集四大方面
- 分布式系统的复杂性
   1. 服务之间的分布式事务问题
   2. 服务之间的分布式一致性问题
   3. 服务之间的分布式通信问题；
         每个客户端请求有一个服务实例来响应/多个服务器相应。
         同步相应还是异步相应
- 业务方面
    数据隔离再来的报表处理问题
- 开发方面：
    相互依赖各个服务在持续开发的情况下仍然保持协同合作
- 测试方面
    服务拆分后，几乎所有功能都会涉及多个服务

### 修复 ( 运维角度：监控->定位为题->分析问题， 开发角度： 多实例的服务注册与发现->权限->熔断降级 )
1. 建立完善的监控体系
     1. 微服务架构中组件繁多，各个组件所需要监控的指标不同
     2. 一般的做法是让各个组件提供报告自己当前状态的接口（metrics接口），这个接口输出的数据格式应该是一致的。
     3. 指标采集器组件(Prometheus)，定时从这些接口获取并保持组件状态，同时提供查询服务
     4. 需要一个UI(Grafana)，从指标采集器查询各项指标，绘制监控界面或者根据阈值发出告警
2. 定位问题 - 链路跟踪 (只定位到哪个服务出现问题，不能提供具体的错误信息)
    1. 实现链路跟踪，每次服务调用会在HTTP的HEADERS中记录至少记录四项数据：
         traceId：traceId标识一个用户请求的调用链路。具有相同traceId的调用属于同一条链路。
         spanId：标识一次服务调用的ID，即链路跟踪的节点ID。
         parentId：父节点的spanId。
         requestTime & responseTime：请求时间和响应时间
    2. 调用日志收集与存储的组件，以及展示链路调用的UI组件
3. 分析问题 - 日志分析
      数据源一侧还需要收集日志的组件
      日志的“搜索引擎”
      展示结果的UI组件
4. 网关 - 权限控制
       在调用者和被调用者中间加一层网关，每次调用时进行权限校验。
       防止调用了不该调用的服务，本来一个只读的功能结果修改了数据……
       常用的微服务网关有：
       zuul, nginx,spring-cloud-gateway,Linkerd
6. 服务注册于发现 - 动态扩容
     服务发现组件：Zookeeper 、Eureka、Consul、Etcd等
7. 负载均衡
      ribbon
8. 熔断、服务降级、限流
     hystrix, sentinel

### 微服务框架
1. spring-cloud， dubbo(dubbo只提供了服务治理，其他的需要额外组件)
   开发一套所有的应用服务都统一使用微服务框架，将与各个组件对接的代码和另外一些公共代码抽离到框架中
    (指标接口、链路跟踪注入、日志引流、服务注册发现、路由规则等组件以及熔断、限流等功能)        
2. Service Mesh(Google、IBM、Lyft主导研发的istio网格化服务框架 )
    另一种抽象公共代码的方法是直接将这些代码抽象到一个反向代理组件。
    每个服务都额外部署这个代理组件，所有出站入站的流量都通过该组件进行处理和转发。这个组件被称为Sidecar。
    Service Mesh来管理众多sidecar。
      彻底把业务和服务治理逻辑切分开(没有语言和框架依赖)
      更灵活，更细粒度的流量管理
      监控，日志，链路跟踪提供编辑、统一的规范
  
- 自研 VS Sevice Mesh
  1.入侵代码，
       自研入侵代码，可以实现很多自定义功能；
       Sevice Mesh不侵入代码，升级和维护更方便。
  2.性能问题
       Sevice Mesh性能相对不好。sidecar和微服务节点的通信实际上都只是通过内存拷贝实现的
       即使回环网络不会产生实际的网络请求，但仍然有内存拷贝的额外成本。
  3. 成本
      自研框架更新成本很高。
      
      
### 通信方式
1.同步：RPC ,REST等。
2.异步：消息队列，要考虑消息的可靠传输、高性能，以及编程模型的变化等。

### 什么是服务治理
- 服务有问题，需要治理
   1. 服务注册与发现
   2. 可观测性： 日志，监控报警
   3. 流量管理
   4. 安全，权限鉴别；
   