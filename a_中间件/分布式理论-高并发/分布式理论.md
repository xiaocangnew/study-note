### CAP理论和 BASE理论
- CAP是理论模型，BASE才是分布式落地方案

- CAP
  - C 强一致性(cosistency)，也就是分布式系统中，集群中的节点的数据保持完全一致
  - A 系统可用性(available)，即使出现网络分区或者异常，整个系统的功能仍然可用
  - P 分区容忍性(Partition tolerance),遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务。
        (个人理解： p就是允许存在网络分区，如果不允许网络分区，只能在单机上。因为网络故障不可避免，即分布式系统不可避免出现网络分区)

- BASE
   - BA 基本可用，是对A的一个妥协，比如秒杀场景下，或者雪崩的业务场景下，可以降级处理，使核心功能可用，而不是所有的功能可用。或者延迟完成，比如通过削峰限流，来延迟响应。
   - Soft Status：对应的是ACID里面的数据一致性的状态。也就是在一个时间节点上，集群中所有节点的数据，可能不一样
   - Eventurlly Consitence：最终一致性，BASE不保证强一致性，但是会通过共识协议最终实现各个集群节点状态的一致性，比如Zab协议、Raft协议
    
- Zookeeper就是典型的BASE理论的践行者：
   事务操作的时候，只要过半节点完成了ACK，就可以提交事务响应客户端了。
   也就是不保证数据的强一致性和存在软状态。另外zk集群的leader会记录每个Node的数据状态，并且不停的尝试让Follower的数据和自己保持一致，这就是最终一致性。

### 一致性hash
- 是什么
- 解决什么问题
1. 分布式系统动态扩缩容的问题(负载均衡)，尽量少的影响业务。以缓存为例，最主要就是解决了节点增加减少引起的缓存大批量的抖动失效
2. 机器down掉瞬间流量打到下一台机器，导致雪崩等。
- 缺点：
1. 算法使用不当会导致hash不均匀
2. 一致性哈希算法在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜问题

### 限流、熔断、一致性选举算法、主从架构、集群架构、异地多活、负载均衡、分层架构、微服务等。

### 分布式id生成器
- 1. 数据库自增ID
   业务系统每次需要一个ID时，都需要请求数据库获取，性能低，并且如果此数据库实例下线了，那么将影响所有的业务系统。
- 2. 数据库多主模式
   2.1 主从模式，如果master宕机，slave可能丢失数据
   2.2 单master存在性能不够，需要多master，每个master递增的step不同， 存在扩容困难。
- 3. redis的incr命令生成。
   内存数据库，使用aof或者rdb时，存在丢数据情况。
- 4. 号段模式 
   4.1 号段可以理解成批量获取，比如DistributIdService从数据库获取ID时，如果能批量获取多个ID并缓存在本地的话，那样将大大提供业务应用获取ID的效率。
   4.2 这种方案不再强依赖数据库，就算数据库不可用，那么DistributIdService也能继续支撑一段时间。但是如果DistributIdService重启，会丢失一段ID，导致ID空洞。
   4.3 如果做分布式时，存在并发问题，使用乐观锁。
- 5. 雪花算法
    4.1 是twitter开源的分布式ID生成算法，是一种算法，所以它和上面的三种生成分布式ID机制不太一样，它不依赖数据库。
    4.2 分布式ID固定是一个long型的数字，一个long型占8个字节，也就是64个bit： 
    1bit不用--41bit时间戳差值--10bit机器值--12bit序列号
   雪花算法存在的问题：
   1. 存在时间回拨风险，时间比较，如果回拨，则等待一段回拨时间；
   2. 机器id分配及回收：
   3. 机器id上限
    
### 几种实现幂等的方式
- 1.MVCC方案 
     多版本并发控制，该策略主要使用update with condition（更新带条件来防止）来保证多次外部请求调用对系统的影响是一致的。
     在系统设计的过程中，合理的使用乐观锁，通过version或者updateTime（timestamp）等其他条件，来做乐观锁的判断条件，
     这样保证更新操作即使在并发的情况下，也不会有太大的问题。
- 2.去重表
     在插入数据的时候，插入去重表，利用数据库的唯一索引特性，保证唯一的逻辑。
     这种方法适用于在业务中有唯一标的插入场景中，比如在以上的支付场景
- 3.状态机幂等
    在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机，一般情况下存在有限状态机，
    这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。
    这种方法适合在有状态机流转的情况下
- 4.token机制，防止页面重复提交 
    业务要求：页面的数据只能被点击提交一次 
- 5. 对外提供接口的api如何保证幂等 
    如银联提供的付款接口：需要接入商户提交付款请求时附带：source来源，seq序列号。
    source+seq在数据库里面做唯一索引，防止多次付款
- 6.唯一主键
    利用数据库的主键唯一约束，解决了在insert场景时幂等问题。
    
    
### 解决脑裂的三种方案：
1. 选举的超半数原则；
2. 冗余通信方式，防止一种通信方式失效导致集群中的节点无法通信
3. 共享资源方式。比如能看到共享资源就表示在集群中，能够获得共享资源的锁的就是Leader，看不到共享资源的，就不在集群中。
