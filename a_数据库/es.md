### es治理
1. 内存治理
2. 慢查询治理
3. 高可用治理
4. 规范约定


### es慢查询治理
1. ES使用过程，会因为聚合或者批量的操作，引起ES慢查
2. 增加监控和报警

### es线程池
https://www.elastic.co/guide/cn/elasticsearch/guide/current/dont-touch-these-settings.html

### mapping
建立索引时需要定义文档的数据结构，这种结构叫作映射。 类似mysql中的建表定义

### es 索引动态映射 VS 显示更新
>>> 尽管支持动态添加未定义的字段（动态映射），但以下核心场景仍需要显式更新索引或重建索引.
1. 动态映射的限制场景
    1. 动态添加的字段类型由 ES 自动推断, 无法指定
    2. 部分字段类型（如 geo_point、ip）不会被动态识别，需显式定义
    3. 对象类型的字段
2. 索引架构调整需求
    1. 分片于副本的扩容/收缩/拆分
    2. 修改索引级配置（如刷新间隔 refresh_interval、合并策略）需更新索引设置
    3. 错误映射或分词器导致数据异常时，需重建索引并迁移数据

### ES的准实时性：
写入成功后，并不是立即对搜索可见，默认情况是一秒内可见，由参数refresh_interval控制


### 索引设计规范
1、设置合理的索引分片数和副本数【建议】
      每个索引分片建议30-50GB以内，索引分片数设置后不可以动态修改，请提前规划好，副本数设置后可以动态修改
      若分片过多，写入放大，可能导致性能下降
      当数据达到一定量级后，分片过少，无法充分利用多节点资源，机器资源利用率不平衡
      7.X版本后，每个节点分片默认限制1000（官方不建议调整）
      Shard的大小和数量是影响ES集群稳定行和性能的重要因素之一，实际业务还需根据需求具体调整。
2、设计mapping配置合适的字段类型 【建议】合理的mapping设计，保障索引高效。
      用最小最合适的数据类型，节省空间开销
      仅针对需要分词的字段，合理的设置分词器，建议分词器强制指定，默认分词器为标准分词，对中文查询性能差
      根据业务需求，合理设置各字段属性，包括是否建索引和列存储，当字段类型text ，一定会分词
      字段打平，避免使用nested fields
      不需要分词搜索字段统一使用keyword，声明不分词，不参与倒排索引，减少segment节省内存空间
3、存入仅需要搜索的字段【建议】
      原因：降低索引大小，提高缓存命中率
4、每个索引都配置别名【建议】
      原因：在运行的集群中，可以无缝的从一个索引切换到另一个索引；给多个索引分组，例如按月创建的所有，可以通过别名构造一个最近3个月的索引；
5、设置慢日志  【建议】
      原因：阿里云默认开启慢查询日志，建议根据业务调整阀值，方便治理和排查问题

### 查询规范
1、避免from+size形式深度翻页【强制】
      查询结果集超过1000条，使用scroll api 或者search_after 。不足：不能随意翻页。
      原因：每个shard都需要查询大量数据后，再进行汇总排序、筛选，翻页越深，性能越差。
2、避免前缀模糊查询 【强制】
      可选方案：对text字段进行分词搜索
      原因：当索引数据量较大时，如超过1亿条，模糊匹配，耗时长，性能差，甚至可能内存溢出。
3、使用批量请求【建议】
      原因：bulk批量请求，推荐每批量提交5~15MB数据，提高写入性能。
4、避免复杂的关联查询，比如 join/nested/parent-child 【建议】
      原因：搜索要尽量避免，性能都很差，通过索引设计阶段避免，把需要关联的数据转换成有数据冗余的宽表或通过程序业务逻辑处理
5、大的语句变动和新上语句，需要在测试集群性能验证通过【建议】
      原因：语句差异性能消耗可能上百倍，防止随意修改DSL导致集群被打挂


### 实践指南
1、搜索结果不要返回过大结果集，ES定位是索引引擎，大批量查询占用磁盘io和带宽，同时性能也没有保障
      查询请求默认只返回10条记录，可通过size设置，size默认值10，最大10000，如超过范围将报错。
      可以通过from size 控制读取记录范围
      _source 参数可以控制返回的字段信息
2、冷热分离 （主要是时间维度，日志场景）
      阿里云ES支持在同一集群中设置冷热节点，通过设置索引的冷热属性，分离冷热数据，提高查询效率，参考：https://help.aliyun.com/document_detail/173474.html?spm=a2c4g.11186623.6.821.13ee4637pDc0cc
      配置索引生命周期管理（ILM）参考：https://help.aliyun.com/document_detail/178307.html?spm=a2c4g.11186623.6.823.39573138187oCi
3、动态索引，当索引记录太多，可以根据业务场景对索引进行水平拆分
      通过Rollover API 滚动生成索引，Rollover支持按照时间、文档数量、索引大小自动生成多个索引，
      6.7参考：https://www.elastic.co/guide/en/elasticsearch/reference/6.7/indices-rollover-index.html
      7.10参考：https://www.elastic.co/guide/en/elasticsearch/reference/7.10/indices-rollover-index.html
业务根据场景需求生成索引

4、如果不关心查询结果与查询条件的相关度，只想精准的查找目标数据，建议使用过滤器查询（filter）,更好利用缓存（filter 默认是缓存，普通query不缓存查询结果集）
5、使用路由routing
      写入文档时，可以根据业务场景设置经常查询的字段作为路由字段，查询时，可以过滤掉不必要的分片，加快查询速度。
      routing选择的时候，需要注意避免数据倾斜。
6、ES 默认磁盘使用率 >85% 不再支持写入数据
      默认配置> 85%：禁止写入；>90%：索引分片迁移到其他可用节点；>95%：索引只读
7、创建索引模板
      方便滚动创建索引，方便日志类型管理
8、高并发场景，使用rest client，需要调整连接数，client端连接数
      rest client  默认是30，建议根据并发度调整
      rest client 默认参数不能满足高并发场景，按需调整，提高性能。
10、对日志类型数据，配置索引压缩 降低磁盘空间，提高资源利用率
      Elasticsearch默认使用LZ4压缩算法，着重于压缩和解压缩速度，索引设置"index.codec":"default" 。DEFLATE压缩算法提供较高的压缩比，
      索引设置"index.codec": "best_compression"。对于日志场景，建议配置最佳压缩算法。



### 索引Settings设计
>>>Settings 部分主要针对的是索引的分片大小与分片数的评估。 
> 要点：索引大小预估、分片大小设计、shards_per_nodes、refresh、flush设置、node_left(delayed_timeout)、replicas

2.1 存储评估设置
在创建索引前，应该做一个短暂的评估，重点在于索引的业务类型、存储周期、分片配置这几块。
      写多读少 :一般日志类的数据是写多读少，压力主要在写入端，且数据量很大。
      写少读多 :除日志类外，很多业务类的数据是写少读多，也即数据产生并不是周期性的，可以根据业务和压测进行数据量来进行评估。
对于查询量大的索引，应保证查询性能优先，可以设置尽可能多的分片数，以保证请求平摊提升性能。
2.1.2 存储周期
存储周期决定了索引的存储量上限，用户可以在创建前评估存储周期，可参考业务类型中的来一并评估。
2.1.3 分片配置
分片主要有以下两种作用：
      提升索引水平扩展的能力（扩缩容量）
      提高索引的读写性能，可以充分利用分布式特性，提高吞吐量
分片也有局限：
      一旦创建了分片数，无法更改。因为数据写入时，每个 doc 都会进行路由，将 routing 的 hash 值与分片数取模来确定 doc 对应的分片。
分片大小存储控制在 20GB~40GB 之间，不要超过 50GB。如果单分片存储量超出范围过大，会出现如下问题：
      有超出单分片文档数限制的风险：分片内部对应的是Lucene的索引文件，一个Lucene索引文件包含多个Segment（段），后者是Lucene索引中最小的独立存储单元。因为Segment内部的docId使用Java的Integer。超出此条数2,147,483,519，则索引无法写入，会导致数据丢失
      恢复速度慢： 单分片越大，在节点重启、分片恢复的时候时间就会越长，IO 压力也会越大。同时会影响查询性能
      增加迁移成本：分片是 ES 对数据的隔离，单分片过大还会增加迁移索引数据迁移时间成本


评估存储周期
评估每天的存储量。继而根据单天的存储量 * 存储周期 = 总存储量
初算分片数：根据总存储量 / 分片存储量（日志数据建议50GB、业务数据建议30GB）
分片数不超过节点数的 3 倍：考虑一下 node 数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了 1 个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以， 一般都设置分片数不超过节点数的 3 倍。
微调分片数：如果算得的分片数 << 节点数，可以考虑适当增加分片数量，以提升并发性能。理想情况下：在规模中小型的集群中，分片数 == 节点数能发挥出集群最大的性能。
分析filecache余量：单个节点给filecache的余量得至少为单节点数据量的50%，此外建议jvm堆内存大小小于32G
节点数：<=主分片数 *（副本数+1）
2.1.4 副本设置
副本（ replicas ）主要用来提供集群的高可用。
副本的缺点：影响集群写入性能（写入的时候会主副分片都写入数据）与提升一倍的存储成本
副本的优点：提升查询性能（查询的时候可以主、副分片并行执行）
一般评估副本的数量，需要评估业务的场景和集群节点规模。建议：普通业务1个副本即可，安全等级高、重要性大的，可适当增加副本数。

2.2性能优化设置
索引 Settings 中有很多参数可以直接影响到集群的读写性能，调整到位则事半功倍，一招调错也可能影响全局。
一般来说，集群默认的配置对性能影响不大，但是遇到数据海量的集群可能会出现一些问题，需要调整相关的参数来提高集群的稳定性和读写性能。
文中选取实践中使用最频繁的，效果最佳的两个参数：
index.routing.allocation.total_shards_per_node ：将分配给单个节点的最大分片数（副本和主分片）。默认为无界。
index.refresh_interval ：执行刷新操作的频率，这使得最近对索引的更改对搜索可见。默认为 1s 。
total_shards_per_node 参数主要影响的是集群写入的情况，当一个索引在同一个节点上有多个分片时，海量写入时会极大地飙高此节点的 CPU 占用和 Load 使用量。可以根据节点数、分片数调整此参数。例如：
比如数据节点有 10 个，索引分片数有 8 个，副本数 1 个。则设置为 2 则可。 比如数据节点有 20 个，索引分片数有 5 个，副本数 1 个。则设置为 1 则可。
refresh_interval 参数也是影响写入的性能，默认的 1s 属于近实时的检索，对于实时性要求高的可以适用。但是对于写多读少的日志类数据则不适合，集群要在每秒钟都要生成一个 Segment ，非常耗费资源，影响写入性能。推荐根据业务使用频次来设置此参数：

如果可以接受一定时间的查询延迟，则可以适当调大 refresh_interval 。

我们这边nginx的日志量很大，就单独做了设置，total_shards_per_node 设置为1、refresh_interval 设置为120s 。